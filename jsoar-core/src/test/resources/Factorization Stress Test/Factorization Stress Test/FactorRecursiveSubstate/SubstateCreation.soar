# This file creates and destroys substates effectively

####################################################
###               ELABORATIONS                   ###
####################################################

####################################################
###    CREATE-NUMBER-TO-FACTOR-FROM-COUNTER      ###
# This elaboration is for the counter on the top state
# but never on the recursive substates.  What it does
# is checks whether we should be factoring a number and
# if we should, creating the structure to force a
# subgoal creation.
sp {elaboration*create-number-to-factor-from-counter
   (state <s> ^counter <c>
              ^needs-factorization true
              ^name Factorization)
-->
   (<s> ^number-to-factor <c>)
}
####################################################
###    FACTOR-NUMBER*HAS-FACTORIZATION-OBJECT    ###
# This is an elaboration to check whether there is at least
# one factorization object on the factor-number operator
# because if we didn't check, we wouldn't drop into a substate
# since our apply rule would see that the counter has created
# a needs factorization flag set to true.
sp {elaboration*factor-number*has-factorization-object
   (state <s> ^factorization-object <f-o>)
-->
   (<s> ^has-factorization-object true)
}

####################################################
###                   RULES                      ###
####################################################

####################################################
###               FACTOR-NUMBER                  ###
# This proposes to factor a number that needs
# to be factored
## This will propose and then won't be able
## to apply, forcing a subgoal creation.
sp {propose*factor-number
   (state <s> ^number-to-factor-int <c>
              ^needs-factorization true
             -^number-to-factor-is-prime)
-->
   (<s> ^operator <o> +)
   (<o> ^name factor-number
        ^number-to-factor <c>)
}

# This removes the needs factorization flag from the current
# state.
sp {apply*factor-number*remove-needs-factorization-flag
   (state <s> ^operator <o>
              ^needs-factorization <n-f>
              ^has-factorization-object)
   (<o> ^name factor-number)
-->
   (<s> ^needs-factorization <n-f> -
        ^needs-clean-up true)
}
